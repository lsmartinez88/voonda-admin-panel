import apiClient from "./apiClient"

/**
 * Clase que maneja todas las operaciones CRUD de vehículos
 * Utiliza la API real de Voonda con endpoints documentados
 */

class VehiculosService {
    /**
     * Obtener lista de vehículos con filtros y paginación
     * @param {Object} options - Opciones de consulta
     * @param {number} options.page - Número de página (default: 1)
     * @param {number} options.limit - Límite de resultados por página (default: 12)
     * @param {string} options.orderBy - Campo para ordenar
     * @param {string} options.order - Orden ascendente/descendente
     * @param {string} options.estado_codigo - Filtro por código de estado
     * @param {number} options.yearFrom - Año mínimo para filtrar
     * @param {number} options.yearTo - Año máximo para filtrar
     * @param {number} options.priceFrom - Precio mínimo para filtrar
     * @param {number} options.priceTo - Precio máximo para filtrar
     * @param {string} options.search - Búsqueda por marca/modelo
     * @returns {Promise<Object>} Lista de vehículos con paginación
     */
    async getVehiculos(options = {}) {
        try {
            const params = new URLSearchParams()

            // Agregar parámetros solo si tienen valor
            Object.entries(options).forEach(([key, value]) => {
                if (value !== undefined && value !== null && value !== "") {
                    params.append(key, value)
                }
            })

            const queryString = params.toString()
            const url = queryString ? `/api/vehiculos?${queryString}` : "/api/vehiculos"

            console.log("🚗 Obteniendo vehículos desde API:", url)

            const response = await apiClient.get(url)

            // La API devuelve la estructura: { success, message, vehiculos, pagination }
            return {
                success: true,
                vehiculos: response.data.vehiculos || response.data.data || [],
                pagination: response.data.pagination || {
                    total: response.data.vehiculos?.length || 0,
                    page: options.page || 1,
                    limit: options.limit || 12,
                    pages: Math.ceil((response.data.vehiculos?.length || 0) / (options.limit || 12))
                },
                message: response.data.message || "Vehículos obtenidos exitosamente"
            }
        } catch (error) {
            console.error("❌ Error al obtener vehículos:", error)

            // Manejo de errores específicos
            if (error.response?.status === 401) {
                throw new Error("Token de acceso inválido o expirado")
            }

            if (error.response?.status === 403) {
                throw new Error("No tienes permisos para ver los vehículos")
            }

            throw new Error(error.response?.data?.message || error.message || "Error al obtener los vehículos")
        }
    }

    /**
     * Obtener un vehículo específico por ID
     * @param {string} id - ID del vehículo
     * @returns {Promise<Object>} Datos del vehículo
     */
    async getVehiculoById(id) {
        if (!id) {
            throw new Error("ID del vehículo es requerido")
        }

        try {
            console.log("🚗 Obteniendo vehículo por ID:", id)

            const response = await apiClient.get(`/api/vehiculos/${id}`)

            return {
                success: true,
                vehiculo: response.data.vehiculo || response.data.data,
                message: response.data.message || "Vehículo obtenido exitosamente"
            }
        } catch (error) {
            console.error("❌ Error al obtener vehículo:", error)

            if (error.response?.status === 404) {
                throw new Error("Vehículo no encontrado")
            }

            if (error.response?.status === 401) {
                throw new Error("Token de acceso inválido o expirado")
            }

            throw new Error(error.response?.data?.message || error.message || "Error al obtener el vehículo")
        }
    }

    /**
     * Crear un nuevo vehículo
     * @param {Object} vehiculoData - Datos del vehículo a crear
     * @returns {Promise<Object>} Vehículo creado
     */
    async createVehiculo(vehiculoData) {
        if (!vehiculoData) {
            throw new Error("Datos del vehículo son requeridos")
        }

        // Validar datos antes de enviar
        const validation = this.validateVehiculoData(vehiculoData)
        if (!validation.isValid) {
            throw new Error(`Datos inválidos: ${validation.errors.join(", ")}`)
        }

        try {
            console.log("� Creando nuevo vehículo:", vehiculoData)

            const response = await apiClient.post("/api/vehiculos", vehiculoData)

            return {
                success: true,
                vehiculo: response.data.vehiculo || response.data.data,
                message: response.data.message || "Vehículo creado exitosamente"
            }
        } catch (error) {
            console.error("❌ Error al crear vehículo:", error)

            if (error.response?.status === 400) {
                const details = error.response?.data?.details || []
                const errorMessage = details.length > 0 ? details.map((d) => d.message).join(", ") : error.response?.data?.message
                throw new Error(errorMessage || "Datos del vehículo inválidos")
            }

            if (error.response?.status === 401) {
                throw new Error("Token de acceso inválido o expirado")
            }

            throw new Error(error.response?.data?.message || error.message || "Error al crear el vehículo")
        }
    }

    /**
     * Actualizar un vehículo existente
     * @param {string} id - ID del vehículo a actualizar
     * @param {Object} vehiculoData - Datos a actualizar
     * @returns {Promise<Object>} Vehículo actualizado
     */
    async updateVehiculo(id, vehiculoData) {
        if (!id) {
            throw new Error("ID del vehículo es requerido")
        }

        if (!vehiculoData || Object.keys(vehiculoData).length === 0) {
            throw new Error("Datos a actualizar son requeridos")
        }

        try {
            console.log("🚗 Actualizando vehículo:", id, vehiculoData)

            const response = await apiClient.put(`/api/vehiculos/${id}`, vehiculoData)

            return {
                success: true,
                vehiculo: response.data.vehiculo || response.data.data,
                message: response.data.message || "Vehículo actualizado exitosamente"
            }
        } catch (error) {
            console.error("❌ Error al actualizar vehículo:", error)

            if (error.response?.status === 404) {
                throw new Error("Vehículo no encontrado")
            }

            if (error.response?.status === 400) {
                const details = error.response?.data?.details || []
                const errorMessage = details.length > 0 ? details.map((d) => d.message).join(", ") : error.response?.data?.message
                throw new Error(errorMessage || "Datos del vehículo inválidos")
            }

            if (error.response?.status === 401) {
                throw new Error("Token de acceso inválido o expirado")
            }

            throw new Error(error.response?.data?.message || error.message || "Error al actualizar el vehículo")
        }
    }

    /**
     * Eliminar un vehículo (soft delete)
     * @param {string} id - ID del vehículo a eliminar
     * @returns {Promise<Object>} Confirmación de eliminación
     */
    async deleteVehiculo(id) {
        if (!id) {
            throw new Error("ID del vehículo es requerido")
        }

        try {
            console.log("🚗 Eliminando vehículo:", id)

            const response = await apiClient.delete(`/api/vehiculos/${id}`)

            return {
                success: true,
                message: response.data.message || "Vehículo eliminado exitosamente"
            }
        } catch (error) {
            console.error("❌ Error al eliminar vehículo:", error)

            if (error.response?.status === 404) {
                throw new Error("Vehículo no encontrado")
            }

            if (error.response?.status === 401) {
                throw new Error("Token de acceso inválido o expirado")
            }

            if (error.response?.status === 403) {
                throw new Error("No tienes permisos para eliminar este vehículo")
            }

            throw new Error(error.response?.data?.message || error.message || "Error al eliminar el vehículo")
        }
    }

    /**
     * Obtener todos los estados disponibles para vehículos
     * @returns {Promise<Object>} Lista de estados
     */
    async getEstados() {
        try {
            console.log("🚗 Obteniendo estados de vehículos desde API")

            const response = await apiClient.get("/api/estados")

            return {
                success: true,
                estados: response.data.estados || response.data.data || [],
                message: response.data.message || "Estados obtenidos exitosamente"
            }
        } catch (error) {
            console.error("❌ Error al obtener estados:", error)

            if (error.response?.status === 401) {
                throw new Error("Token de acceso inválido o expirado")
            }

            throw new Error(error.response?.data?.message || error.message || "Error al obtener los estados de vehículos")
        }
    }

    /**
     * Obtener marcas únicas de los vehículos (extraídas de modelo_auto)
     * @returns {Promise<Object>} Lista de marcas
     */
    async getMarcas() {
        try {
            console.log("🚗 Obteniendo marcas de vehículos")

            // Primero obtenemos algunos vehículos para extraer las marcas
            const vehiculosResponse = await this.getVehiculos({ limit: 100 })

            if (vehiculosResponse.success && vehiculosResponse.vehiculos) {
                // Extraer marcas únicas de los vehículos
                const marcasSet = new Set()

                vehiculosResponse.vehiculos.forEach((vehiculo) => {
                    const marca = vehiculo.modelo_auto?.marca
                    if (marca) {
                        marcasSet.add(marca)
                    }
                })

                const marcas = Array.from(marcasSet).map((marca, index) => ({
                    id: index + 1,
                    nombre: marca,
                    codigo: marca.toLowerCase().replace(/ /g, "_"),
                    activo: true
                }))

                return {
                    success: true,
                    marcas: marcas,
                    data: marcas,
                    message: "Marcas obtenidas exitosamente"
                }
            }

            return {
                success: true,
                marcas: [],
                data: [],
                message: "No se encontraron marcas"
            }
        } catch (error) {
            console.error("❌ Error al obtener marcas:", error)
            throw new Error(error.message || "Error al obtener las marcas")
        }
    }

    /**
     * Obtener modelos únicos de una marca específica (extraídos de modelo_auto)
     * @param {string} marca - Nombre de la marca
     * @returns {Promise<Object>} Lista de modelos
     */
    async getModelosByMarca(marca) {
        if (!marca) {
            return {
                success: true,
                modelos: [],
                data: [],
                message: "Marca no especificada"
            }
        }

        try {
            console.log("🚗 Obteniendo modelos para marca:", marca)

            // Obtener vehículos y filtrar por marca
            const vehiculosResponse = await this.getVehiculos({
                limit: 100,
                search: marca // La API busca en marca/modelo
            })

            if (vehiculosResponse.success && vehiculosResponse.vehiculos) {
                // Extraer modelos únicos de la marca específica
                const modelosSet = new Set()

                vehiculosResponse.vehiculos.forEach((vehiculo) => {
                    const vehiculoMarca = vehiculo.modelo_auto?.marca
                    const vehiculoModelo = vehiculo.modelo_auto?.modelo

                    if (vehiculoMarca && vehiculoModelo && vehiculoMarca.toLowerCase() === marca.toLowerCase()) {
                        modelosSet.add(vehiculoModelo)
                    }
                })

                const modelos = Array.from(modelosSet).map((modelo, index) => ({
                    id: index + 1,
                    nombre: modelo,
                    marca: marca,
                    activo: true
                }))

                return {
                    success: true,
                    modelos: modelos,
                    data: modelos,
                    message: "Modelos obtenidos exitosamente"
                }
            }

            return {
                success: true,
                modelos: [],
                data: [],
                message: `No se encontraron modelos para la marca ${marca}`
            }
        } catch (error) {
            console.error("❌ Error al obtener modelos:", error)
            throw new Error(error.message || `Error al obtener modelos de ${marca}`)
        }
    }

    /**
     * Validar datos de vehículo antes de enviar a la API
     * @param {Object} vehiculoData - Datos del vehículo a validar
     * @returns {Object} Resultado de la validación
     */
    validateVehiculoData(vehiculoData) {
        const errors = []
        const currentYear = new Date().getFullYear()

        // Validaciones requeridas según la API
        if (!vehiculoData.modelo_id) {
            errors.push("El modelo es requerido")
        }

        if (!vehiculoData.vehiculo_ano || vehiculoData.vehiculo_ano < 1950 || vehiculoData.vehiculo_ano > currentYear + 1) {
            errors.push(`El año del vehículo debe estar entre 1950 y ${currentYear + 1}`)
        }

        // Validaciones opcionales
        if (vehiculoData.kilometros !== undefined && vehiculoData.kilometros < 0) {
            errors.push("Los kilómetros no pueden ser negativos")
        }

        if (vehiculoData.valor !== undefined && vehiculoData.valor < 0) {
            errors.push("El valor no puede ser negativo")
        }

        if (vehiculoData.patente && vehiculoData.patente.length > 15) {
            errors.push("La patente no puede tener más de 15 caracteres")
        }

        if (vehiculoData.observaciones && vehiculoData.observaciones.length > 1000) {
            errors.push("Las observaciones no pueden tener más de 1000 caracteres")
        }

        if (vehiculoData.moneda && vehiculoData.moneda.length > 10) {
            errors.push("La moneda no puede tener más de 10 caracteres")
        }

        return {
            isValid: errors.length === 0,
            errors
        }
    }

    /**
     * Datos mock para desarrollo
     */
    getMockVehiculos(options = {}) {
        const mockVehiculos = [
            {
                id: 1,
                estado: "DISPONIBLE",
                valor: 25000,
                kilometros: 50000,
                modelo_autos: {
                    marca: "Toyota",
                    modelo: "Corolla",
                    año: 2020,
                    combustible: "Nafta",
                    caja: "Manual"
                },
                created_at: "2024-01-15T10:00:00Z"
            },
            {
                id: 2,
                estado: "VENDIDO",
                valor: 35000,
                kilometros: 30000,
                modelo_autos: {
                    marca: "Ford",
                    modelo: "Focus",
                    año: 2021,
                    combustible: "Nafta",
                    caja: "Automático"
                },
                created_at: "2024-01-10T10:00:00Z"
            },
            {
                id: 3,
                estado: "RESERVADO", 
                valor: 45000,
                kilometros: 20000,
                modelo_autos: {
                    marca: "Chevrolet",
                    modelo: "Cruze",
                    año: 2022,
                    combustible: "Nafta",
                    caja: "Manual"
                },
                created_at: "2024-01-05T10:00:00Z"
            }
        ]

        return {
            isValid: errors.length === 0,
            errors
        }
    }
}

// Crear una instancia única del servicio
const vehiculosService = new VehiculosService()

export default vehiculosService

    getMockEstados() {
        const mockEstados = [
            { codigo: "DISPONIBLE", nombre: "Disponible" },
            { codigo: "VENDIDO", nombre: "Vendido" },
            { codigo: "RESERVADO", nombre: "Reservado" },
            { codigo: "MANTENIMIENTO", nombre: "En Mantenimiento" }
        ]

        return {
            success: true,
            estados: mockEstados,
            message: "Estados mock obtenidos exitosamente"
        }
    }
}

// Crear una instancia única del servicio
const vehiculosService = new VehiculosService()

export default vehiculosService
